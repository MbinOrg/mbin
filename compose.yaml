services:
    php:
        image: mbin
        restart: unless-stopped
        env_file: .env
        environment:
            MERCURE_PUBLISHER_JWT_KEY: ${MERCURE_JWT_SECRET}
            MERCURE_SUBSCRIBER_JWT_KEY: ${MERCURE_JWT_SECRET}
        volumes:
            - ./storage/caddy_data:/data
            - ./storage/caddy_config:/config
            - ./storage/media:/app/public/media
            - ./storage/php_logs:/app/var/log
        ports:
            - 80:80
            - 443:443
            - 443:443/udp
        depends_on:
            - postgres
            - rabbitmq
            - redis

    messenger:
        image: mbin
        restart: unless-stopped
        env_file: .env
        command: bin/console messenger:consume scheduler_default old async outbox deliver inbox resolve receive failed --time-limit=3600
        healthcheck:
            test: ['CMD-SHELL', "ps aux | grep 'messenger[:]consume' || exit 1"]
        volumes:
            - ./storage/media:/app/public/media
            - ./storage/messenger_logs:/app/var/log
        depends_on:
            - postgres
            - rabbitmq
            - redis

    postgres:
        image: postgres:${POSTGRES_VERSION}-alpine
        restart: unless-stopped
        env_file: .env
        volumes:
            - ./storage/postgres:/var/lib/postgresql/data

    rabbitmq:
        image: rabbitmq:3-management-alpine
        restart: unless-stopped
        env_file: .env
        volumes:
            - ./storage/rabbitmq_data:/var/lib/rabbitmq
            - ./storage/rabbitmq_logs:/var/log/rabbitmq
        ports:
            - 15672:15672

    redis:
        image: redis:alpine
        restart: unless-stopped
        command: redis-server /redis.conf --requirepass ${REDIS_PASSWORD}
        healthcheck:
            test: ['CMD', 'redis-cli', 'ping']
        volumes:
            - ./docker/redis.conf:/redis.conf
